<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker</title>
    <style>
        /* --- ∆èSAS STƒ∞LL∆èR --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            min-height: 100vh;
            padding: 30px;
            color: #f0f0f0;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #2c394b;
            border-radius: 18px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        /* --- HEADER (√úst Panel) --- */
        .header {
            background: linear-gradient(135deg, #1f4068 0%, #00a8e8 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 3em;
            letter-spacing: 1.5px;
            margin-bottom: 5px;
            font-weight: 800;
        }

        .header p {
            margin-top: 5px;
            font-size: 1.1em;
            color: #d0d0d0;
        }

        /* --- BA≈ûLIQLAR --- */
        h2 {
            margin-bottom: 25px;
            margin-top: 15px;
            color: #00a8e8;
            font-weight: 600;
            padding-bottom: 5px;
            border-bottom: 2px solid rgba(0, 168, 232, 0.5);
        }

        h3 {
            color: #ff5722; /* Daha yax≈üƒ± ayrƒ±lmasƒ± √º√ß√ºn Narƒ±ncƒ± */
            margin-top: 20px;
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 3px solid #ff5722;
        }

        /* --- TABLAR --- */
        .tabs {
            display: flex;
            background: #24303f;
            border-bottom: 1px solid #444;
        }

        .tab {
            flex: 1;
            padding: 18px;
            font-weight: 600;
            transition: all 0.3s;
            color: #a0a0a0;
            background: transparent;
        }

        .tab:hover {
            background: #2c394b;
            color: #f0f0f0;
        }

        .tab.active {
            background: #2c394b;
            color: #00a8e8;
            border-bottom: 3px solid #00a8e8;
        }

        /* --- FORMLAR V∆è INPUTLAR (YAZI YERL∆èRƒ∞) --- */
        .content {
            padding: 30px;
        }

        /* Tab kontentl…ôrini gizl…ôtm…ôk √º√ß√ºn */
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #f0f0f0;
            font-size: 1.05em;
            margin-bottom: 8px; /* label altƒ±nda m…ôsaf…ô */
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            font-size: 16px;
            color: #ffffff;
            transition: all 0.3s;
        }

        ::placeholder {
            color: #a0a0a0;
            opacity: 1;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00a8e8;
            box-shadow: 0 0 10px rgba(0, 168, 232, 0.8);
            background-color: rgba(255, 255, 255, 0.15);
        }

        /* --- D√úYM∆èL∆èR --- */
        button {
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, #00a8e8 0%, #0077b6 100%);
            color: white;
            padding: 14px 35px;
            border-radius: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 5px 15px rgba(0, 168, 232, 0.4);
            transition: all 0.3s;
            margin-top: 10px; /* Formlarda d√ºym…ô √ºz…ôrind…ô m…ôsaf…ô */
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 25px rgba(0, 168, 232, 0.8);
        }

        /* --- KARTLAR --- */
        .card {
            background: #344358;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #444;
            border-left: 6px solid #ff5722;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            margin-bottom: 15px;
        }

        .card h3 {
            color: #00a8e8;
            margin-bottom: 12px;
            font-size: 1.5em;
            line-height: 1.2;
        }

        .card p {
            color: #d0d0d0;
            margin-bottom: 8px;
        }

        /* --- Dƒ∞G∆èR --- */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üéØ Habit Tracker</h1>
        <p>V…ôrdi≈ül…ôrinizi izl…ôyin v…ô inki≈üaf edin!</p>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('usersSection', this)">ƒ∞stifad…ô√ßil…ôr</button>
        <button class="tab" onclick="showTab('habitsSection', this)">V…ôrdi≈ül…ôr</button>
        <button class="tab" onclick="showTab('entriesSection', this)">Qeydl…ôr & Level</button>
    </div>

    <div class="content">

        <div id="usersSection" class="section active">

            <h2>Yeni ƒ∞stifad…ô√ßi v…ô ƒ∞lk V…ôrdi≈ü Yarat</h2>
            <p style="margin-bottom: 25px; color: #a0a0a0;">Qeyd: Yeni istifad…ô√ßi yaratmaq √º√ß√ºn …ôn azƒ± bir v…ôrdi≈ü daxil edilm…ôlidir.</p>

            <div id="userCreationForm">
                <h3>üë§ ƒ∞stifad…ô√ßi M…ôlumatlarƒ±</h3>
                <div class="form-group">
                    <label>Ad:</label>
                    <input type="text" id="userName" placeholder="Adƒ±nƒ±zƒ± daxil edin">
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="userEmail" placeholder="Email √ºnvanƒ±nƒ±zƒ± daxil edin">
                </div>

                <hr style="margin: 25px 0; border: 1px solid #444;">

                <h3>üéØ ƒ∞lk V…ôrdi≈ü M…ôlumatlarƒ±</h3>
                <div class="form-group">
                    <label>V…ôrdi≈ü Adƒ±:</label>
                    <input type="text" id="userFirstHabitName" placeholder="M…ôs…ôl…ôn: Kitab oxumaq">
                </div>
                <div class="form-group">
                    <label>A√ßƒ±qlama:</label>
                    <textarea id="userFirstHabitDesc" rows="3" placeholder="V…ôrdi≈ü haqqƒ±nda qƒ±sa m…ôlumat"></textarea>
                </div>
                <div class="form-group">
                    <label>Tezlik:</label>
                    <select id="userFirstHabitFreq">
                        <option value="DAILY">G√ºnd…ôlik</option>
                        <option value="WEEKLY">H…ôft…ôlik</option>
                        <option value="MONTHLY">Aylƒ±q</option>
                        <option value="CUSTOM">X√ºsusi</option>
                    </select>
                </div>
                <button onclick="createUser()">ƒ∞stifad…ô√ßi v…ô V…ôrdi≈ü Yarat</button>
            </div>

            <h2 style="margin-top: 40px;">B√ºt√ºn ƒ∞stifad…ô√ßil…ôr (Qeydl…ôrin Silinm…ôsi)</h2>
            <div id="usersList"></div>
        </div>

        <div id="habitsSection" class="section">

            <h2>M√∂vcud ƒ∞stifad…ô√ßiy…ô Yeni V…ôrdi≈ü ∆èlav…ô Et</h2>
            <div id="habitCreationForm">
                <div class="form-group">
                    <label>ƒ∞stifad…ô√ßi ID:</label>
                    <input type="number" id="habitUserId" placeholder="V…ôrdi≈ü …ôlav…ô edil…ôc…ôk istifad…ô√ßinin ID-si">
                </div>
                <div class="form-group">
                    <label>V…ôrdi≈ü Adƒ±:</label>
                    <input type="text" id="habitName" placeholder="M…ôs…ôl…ôn: S…ôh…ôr idmanƒ±">
                </div>
                <div class="form-group">
                    <label>A√ßƒ±qlama:</label>
                    <textarea id="habitDesc" rows="3" placeholder="V…ôrdi≈ü haqqƒ±nda qƒ±sa m…ôlumat"></textarea>
                </div>
                <div class="form-group">
                    <label>Tezlik:</label>
                    <select id="habitFreq">
                        <option value="DAILY">G√ºnd…ôlik</option>
                        <option value="WEEKLY">H…ôft…ôlik</option>
                        <option value="MONTHLY">Aylƒ±q</option>
                        <option value="CUSTOM">X√ºsusi</option>
                    </select>
                </div>
                <button onclick="createHabit()">V…ôrdi≈ü Yarat</button>
            </div>

            <h2 style="margin-top: 40px;">B√ºt√ºn V…ôrdi≈ül…ôr (Streak V…ôziyy…ôti)</h2>
            <div id="habitsList"></div>
        </div>

        <div id="entriesSection" class="section">

            <h2>V…ôrdi≈üi Tamamla (Yeni Qeyd ∆èlav…ô Et)</h2>
            <div id="markCompletedForm">
                <div class="form-group">
                    <label>ƒ∞stifad…ô√ßi ID:</label>
                    <input type="number" id="entryUserId" placeholder="ƒ∞stifad…ô√ßi ID">
                </div>
                <div class="form-group">
                    <label>V…ôrdi≈ü ID:</label>
                    <input type="number" id="entryHabitId" placeholder="V…ôrdi≈ü ID">
                </div>
                <div class="form-group">
                    <label>Tarix:</label>
                    <input type="date" id="entryDate">
                </div>
                <button onclick="markHabitCompleted()">Tamamlandƒ± ‚úì</button>
            </div>

            <hr style="margin: 40px 0; border: 1px solid #444;">

            <h2>Level Hesablama</h2>
            <div id="levelCalculationForm">
                <div class="form-group">
                    <label>ƒ∞stifad…ô√ßi ID:</label>
                    <input type="number" id="levelUserId" placeholder="ƒ∞stifad…ô√ßi ID">
                </div>
                <button onclick="calculateLevel()">Level Hesabla</button>
                <div id="levelDisplay"></div>
            </div>
        </div>

    </div>
</div>

<script>
    const API_BASE = 'http://localhost:8080/habitTrackerAPI';

    // Funksiya: Aktiv tabƒ± d…ôyi≈üir v…ô m√ºvafiq m…ôlumatlarƒ± y√ºkl…ôyir
    function showTab(tabName, element) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        element.classList.add('active');

        if (tabName === 'usersSection') loadUsers();
        if (tabName === 'habitsSection') loadHabits();
        // 'entriesSection' m…ôlumat y√ºkl…ômir, formlarƒ± g√∂st…ôrir
    }

    // ==============================================
    // 1. ƒ∞STƒ∞FAD∆è√áƒ∞ FUNKSƒ∞YALARI
    // ==============================================

    async function createUser() {
        const name = document.getElementById('userName').value;
        const email = document.getElementById('userEmail').value;
        const habitName = document.getElementById('userFirstHabitName').value;
        const habitDescription = document.getElementById('userFirstHabitDesc').value;
        const frequency = document.getElementById('userFirstHabitFreq').value;

        if (!name || !email || !habitName || !habitDescription) {
            alert('ƒ∞stifad…ô√ßi adƒ±, email v…ô ilk v…ôrdi≈ü √º√ß√ºn b√ºt√ºn m…ôlumatlarƒ± doldurun!');
            return;
        }

        const userRequest = {
            name: name.trim(),
            email: email.trim(),
            habits: [{
                habitName: habitName.trim(),
                habitDescription: habitDescription.trim(),
                frequency: frequency
            }]
        };

        try {
            const response = await fetch(`${API_BASE}/user/createUser`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userRequest)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Server x…ôtasƒ±: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            alert('ƒ∞stifad…ô√ßi v…ô ilk v…ôrdi≈üi yaradƒ±ldƒ±! ƒ∞stifad…ô√ßi ID: ' + data.id);
            loadUsers();

            // Formu t…ômizl…ôm…ôk
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userFirstHabitName').value = '';
            document.getElementById('userFirstHabitDesc').value = '';

        } catch (error) {
            console.error('Error:', error);
            alert('X…ôta: ' + error.message);
        }
    }

    async function loadUsers() {
        const list = document.getElementById('usersList');
        list.innerHTML = '<div class="loading" style="color:#00a8e8;">Y√ºkl…ônir...</div>';

        try {
            const response = await fetch(`${API_BASE}/user/getAllUsers?page=0&size=20`);

            if (!response.ok) throw new Error(`HTTP x…ôtasƒ±: ${response.status}`);

            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
                const data = await response.json();
                list.innerHTML = '';

                if (!data.content || data.content.length === 0) {
                    list.innerHTML = '<p style="text-align:center;padding:20px;color:#a0a0a0;">He√ß bir istifad…ô√ßi tapƒ±lmadƒ±</p>';
                    return;
                }

                const grid = document.createElement('div');
                grid.className = 'grid';

                data.content.forEach(user => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <h3>üë§ ${user.name}</h3>
                        <p><strong>ID:</strong> ${user.id}</p>
                        <p><strong>Email:</strong> ${user.email || 'Yoxdur'}</p>
                        <p><strong>V…ôrdi≈ül…ôr:</strong> ${user.habits?.length || 0}</p>
                        <div class="card-actions" style="margin-top: 15px;">
                            <button class="btn-small btn-danger" onclick="deleteUser(${user.id})">Sil</button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                list.appendChild(grid);
            } else {
                const errorText = await response.text();
                throw new Error(`Server cavabƒ± JSON formatƒ±nda deyil. Cavab: ${errorText.substring(0, 50)}...`);
            }


        } catch (error) {
            console.error('Load users error:', error);
            list.innerHTML = `<p style="color:#ff5252;text-align:center;padding:20px;">ƒ∞stifad…ô√ßil…ôri y√ºkl…ôy…ôrk…ôn x…ôta ba≈ü verdi: ${error.message}</p>`;
        }
    }

    async function deleteUser(id) {
        if (confirm(`ƒ∞stifad…ô√ßi #${id}-i silm…ôk ist…ôdiyinizd…ôn …ôminsiniz?`)) {
            try {
                const response = await fetch(`${API_BASE}/user/deleteUser/${id}`, { method: 'DELETE' });
                if (!response.ok && response.status !== 204) throw new Error(`Server x…ôtasƒ±: ${response.status}`);
                alert('ƒ∞stifad…ô√ßi silindi!');
                loadUsers();
            } catch (error) {
                console.error("Delete user error:", error);
                alert('X…ôta: ' + error.message);
            }
        }
    }

    async function calculateLevel() {
        const userId = document.getElementById('levelUserId').value;
        const display = document.getElementById('levelDisplay');
        display.innerHTML = '';

        if(!userId) {
            alert("ƒ∞stifad…ô√ßi ID daxil edin.");
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/user/calculate-level/${userId}`, {
                method: 'POST'
            });

            if(!response.ok) {
                const errorText = await response.text();
                throw new Error(`Server x…ôtasƒ±: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            let levelInfo = "M…ôlumat tapƒ±lmadƒ±";
            if(data && Object.keys(data).length > 0) {
                const levelKey = Object.keys(data)[0];
                const levelValue = data[levelKey];
                levelInfo = `${levelValue} (${levelKey})`;
            }

            display.innerHTML = `<div class="level-display" style="margin-top: 20px;">üèÖ Level: ${levelInfo}</div>`;
        } catch (error) {
            console.error("Calculate level error:", error);
            display.innerHTML = `<p style="color:#ff5252; margin-top: 20px;">X…ôta: ${error.message}</p>`;
        }
    }


    // ==============================================
    // 2. V∆èRDƒ∞≈û FUNKSƒ∞YALARI
    // ==============================================

    async function createHabit() {
        const userId = document.getElementById('habitUserId').value;
        const habitName = document.getElementById('habitName').value;
        const habitDescription = document.getElementById('habitDesc').value;
        const frequency = document.getElementById('habitFreq').value;

        if (!userId || !habitName || !habitDescription) {
            alert("B√ºt√ºn xanalarƒ± doldurun!");
            return;
        }

        try {
            const userResponse = await fetch(`${API_BASE}/user/getUserById/${userId}`);
            if(!userResponse.ok) throw new Error(`ƒ∞stifad…ô√ßi tapƒ±lmadƒ±: ID ${userId}`);
            const user = await userResponse.json();

            // D√∂vri referans problemi √º√ß√ºn (∆èg…ôr API t…ôr…ôfind…ô problem yaradƒ±rsa)
            user.habits = null;

            const response = await fetch(`${API_BASE}/habit/createHabit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ habitName, habitDescription, frequency, user })
            });

            if(!response.ok) {
                const errorText = await response.text();
                throw new Error(`Server x…ôtasƒ±: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            alert('V…ôrdi≈ü yaradƒ±ldƒ±! ID: ' + data.id);
            loadHabits();
            document.getElementById('habitName').value = '';
            document.getElementById('habitDesc').value = '';
        } catch (error) {
            console.error("Create habit error:", error);
            alert('X…ôta: ' + error.message);
        }
    }

    async function loadHabits() {
        const list = document.getElementById('habitsList');
        list.innerHTML = '<div class="loading" style="color:#00a8e8;">Y√ºkl…ônir...</div>';

        try {
            const response = await fetch(`${API_BASE}/habit/getAllHabits`);
            if (!response.ok) throw new Error(`HTTP x…ôtasƒ±: ${response.status}`);

            const habits = await response.json();
            list.innerHTML = '';

            if (!habits || habits.length === 0) {
                list.innerHTML = '<p style="text-align:center;padding:20px;color:#a0a0a0;">He√ß bir v…ôrdi≈ü tapƒ±lmadƒ±.</p>';
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'grid';

            habits.forEach(habit => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>üéØ ${habit.habitName}</h3>
                    <p><strong>ID:</strong> ${habit.id}</p>
                    <p><strong>Sahib ID:</strong> ${habit.user?.id || '?'}</p>
                    <p>${habit.habitDescription}</p>
                    <p><strong>Tezlik:</strong> ${habit.frequency}</p>
                    <div style="margin-top: 10px;">
                        <span class="streak-badge">üî• ${habit.currentStreak || 0} g√ºn</span>
                        <span class="streak-badge">üèÜ Max: ${habit.longestStreak || 0}</span>
                    </div>
                    <div class="card-actions" style="margin-top: 15px;">
                        <button class="btn-small btn-danger" onclick="deleteHabit(${habit.id})">Sil</button>
                    </div>
                `;
                grid.appendChild(card);
            });
            list.appendChild(grid);
        } catch (error) {
            console.error("Load habits error:", error);
            list.innerHTML = `<p style="color:#ff5252;text-align:center;padding:20px;">V…ôrdi≈ül…ôri y√ºkl…ôy…ôrk…ôn x…ôta ba≈ü verdi: ${error.message}</p>`;
        }
    }

    async function deleteHabit(id) {
        if (confirm(`V…ôrdi≈ü #${id}-i silm…ôk ist…ôdiyinizd…ôn …ôminsiniz?`)) {
            try {
                const response = await fetch(`${API_BASE}/habit/deleteHabit/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error(`Server x…ôtasƒ±: ${response.status}`);
                alert('V…ôrdi≈ü silindi!');
                loadHabits();
            } catch (error) {
                console.error("Delete habit error:", error);
                alert('X…ôta: ' + error.message);
            }
        }
    }

    // ==============================================
    // 3. QEYD FUNKSƒ∞YALARI
    // ==============================================

    async function markHabitCompleted() {
        const userId = document.getElementById('entryUserId').value;
        const habitId = document.getElementById('entryHabitId').value;
        const date = document.getElementById('entryDate').value;

        if (!userId || !habitId || !date) {
            alert("B√ºt√ºn xanalarƒ± doldurun!");
            return;
        }

        try {
            const habitResponse = await fetch(`${API_BASE}/habit/getHabitById/${habitId}`);
            if(!habitResponse.ok) throw new Error(`V…ôrdi≈ü tapƒ±lmadƒ±: ID ${habitId}`);
            const habit = await habitResponse.json();

            if(habit.user) habit.user.habits = null; // D√∂vri referansƒ± √∂nl…ôm…ôk

            const response = await fetch(`${API_BASE}/habitEntry/markHabitAsCompleted`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ habitId: habit, date, userId: parseInt(userId) })
            });

            if(!response.ok) {
                const errorText = await response.text();
                throw new Error(`Server x…ôtasƒ±: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            alert('V…ôrdi≈ü tamamlandƒ±! üéâ');
            // Qeyd yaradƒ±ldƒ±qdan sonra V…ôrdi≈ül…ôr b√∂lm…ôsini yenil…ôyin ki, streak g√∂rs…ônsin
            if (document.getElementById('habitsSection').classList.contains('active')) {
                loadHabits();
            }
        } catch (error) {
            console.error("Mark habit error:", error);
            alert('X…ôta: ' + error.message);
        }
    }

    // S…ôhif…ô y√ºkl…ôn…ônd…ô ilkin funksiyalar
    document.addEventListener('DOMContentLoaded', () => {
        const dateInput = document.getElementById('entryDate');
        if(dateInput) {
            dateInput.valueAsDate = new Date();
        }
        // Ba≈ülanƒüƒ±cda ƒ∞stifad…ô√ßil…ôr siyahƒ±sƒ±nƒ± y√ºkl…ô
        loadUsers();
    });
</script>
</body>
</html>